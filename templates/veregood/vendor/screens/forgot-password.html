{% extends 'veregood/vendor/base.html' %}
{% load static %}

<!-- Header -->
{% block meta %}{% endblock %}
{% block title %}<title>VereGood | OTP Verification</title>{% endblock %}


{% block css %}
    <style>
        .auth .brand-logo img {
        width: 180px;
    }
    </style>
{% endblock %}


{% block favicon %}{% endblock %}
<!-- Header -->

{% block content %}

<div class="container-scroller">
    <div class="container-fluid page-body-wrapper full-page-wrapper">
      <div class="content-wrapper d-flex align-items-center auth px-0">
        <div class="row w-100 mx-0">
          <div class="col-lg-4 mx-auto">
            <div class="auth-form-light text-left py-5 px-4 px-sm-5">
              <div class="brand-logo">
                <img src="{% static 'veregood/images/logo.png' %}" alt="logo">
              </div>
              <h4>Verify Captcha & Verify Otp</h4>
              


              <form method="post" id="login" enctype="multipart/form-data" class="pt-3">
                  {% csrf_token %}
                <div class="form-group">
                    <!-- Add two inputs for "phoneNumber" and "code" -->
                <input readonly class="form-control form-control-lg" type="tel" id="phoneNumber" value="{{ request.session.country_code }}{{ request.session.mobile_number }}"/>
                </div>
                <div class="form-group">
                <label>Enter OTP</label>
                
                 <input class="form-control form-control-lg" type="text" id="code" placeholder="Enter OTP" />
                 <input id="verification" name="verification" hidden/>
                  
                </div>
                <div class="mb-2">
                    <!-- Add a container for reCaptcha -->
                      <div id="recaptcha-container"></div>
                </div>
                <div class="mb-2">
                   {{ message }}
                </div>

                <input name="mobile_number" value="{{ request.session.mobile_number }}" hidden/>
                <input name="password" value="{{ request.session.password }}" hidden/>
                
                <div class="mt-3">
                    <button onclick=submitPhoneNumberAuthCode() class="btn btn-block btn-primary btn-lg font-weight-medium auth-form-btn">submit</button>
                  </div>
                
              
              </form>



            </div>
          </div>
        </div>
      </div>
      <!-- content-wrapper ends -->
    </div>
    <!-- page-body-wrapper ends -->
  </div>

{% endblock %}
    

    

    {% block js %}
    <script src="{% static 'veregood/admin/vendors/js/vendor.bundle.base.js' %}"></script>
    <script src="{% static 'veregood/admin/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js' %}"></script>
    <!-- Add the latest firebase dependecies from CDN -->
    <script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-auth.js"></script>

    <script>

    
    // Paste the config your copied earlier
    var firebaseConfig = {
        apiKey: "AIzaSyCE9nDNg6kH4yD9bVfHNcKykmE3IPHA94Y",
        authDomain: "localhost",
        projectId: "veregood-91336",
        storageBucket: "veregood-91336.appspot.com",
        messagingSenderId: "316366126377",
        appId: "1:316366126377:web:1090f94133fa354110cb38",
        measurementId: "G-0CXHJ8R548"
    };

    firebase.initializeApp(firebaseConfig);

    // Create a Recaptcha verifier instance globally
    // Calls submitPhoneNumberAuth() when the captcha is verified
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
        "recaptcha-container",
        {
        size: "normal",
        callback: function(response) {
            submitPhoneNumberAuth();
        }
        }
    );

    // This function runs when the 'sign-in-button' is clicked
    // Takes the value from the 'phoneNumber' input and sends SMS to that phone number
    function submitPhoneNumberAuth() {
        var phoneNumber = document.getElementById("phoneNumber").value;
        var appVerifier = window.recaptchaVerifier;
        firebase
        .auth()
        .signInWithPhoneNumber(phoneNumber, appVerifier)
        .then(function(confirmationResult) {
            window.confirmationResult = confirmationResult;
        })
        .catch(function(error) {
            console.log(error);
        });
    }

    // This function runs when the 'confirm-code' button is clicked
    // Takes the value from the 'code' input and submits the code to verify the phone number
    // Return a user object if the authentication was successful, and auth is complete
    function submitPhoneNumberAuthCode() {
        var code = document.getElementById("code").value;
        confirmationResult
        .confirm(code)
        .then(function(result) {
            var user = result.user;
            console.log(user);
        })
        .catch(function(error) {
            console.log(error);
        });
    }

    //This function runs everytime the auth state changes. Use to verify if the user is logged in
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
        console.log("USER LOGGED IN");
        document.getElementById("login").submit(); 
        } else {
        // No user is signed in.
        console.log("USER NOT LOGGED IN");
        }
    });


    window.onload = submitPhoneNumberAuth();
    </script>
    {% endblock %} 




